name: CD Pipeline - Deploy to Azure VM

on:
  workflow_run:
    workflows: ["CI Pipeline - Build, Test & Docker Push"]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Debug host value
        run: |
          echo "Host: ${{ secrets.AZURE_VM_IP }}"
   
      - name: Azure Login (Service Principal)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Pull and run Docker on Azure VM
        run: |
          IMAGE=${{ secrets.DOCKER_USERNAME }}/node-app:${{ github.sha }}
          echo "Deploying Docker image to Azure VM..."
          
          # Use Azure Run Command to execute Docker commands on VM instead of SSH
          az vm run-command invoke \
            --name ${{ secrets.AZURE_VM_NAME }} \
            --resource-group ${{ secrets.AZURE_VM_RESOURCE_GROUP }} \
            --command-id RunShellScript \
            --scripts "
              echo "Pulling latest Docker image..."
              sudo docker pull $IMAGE
              echo "Stopping old container..."
              sudo docker stop node-app || true
              sudo docker rm node-app || true
              echo "Running new container..."
              sudo docker run -d --name node-app -p 80:3000 $IMAGE
  
